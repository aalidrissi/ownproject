// Masquer les catégories qui n'ont qu'une seule image
document.addEventListener('DOMContentLoaded', function() {
  document.querySelectorAll('.tv-category-cover').forEach(function(div) {
    if (div.querySelectorAll('img').length === 1) {
      div.style.display = 'none';
    }
  });
});

/* === Owl Carousel - Safe loader pour les 2 sliders === */
(function () {
  'use strict';

  var SEL_CAT = '.tvcategory-slider-content-box.owl-carousel';           // Slider "catégories" (icônes/accroches)
  var SEL_TAB = '.tvtabcategory-all-product-slider.owl-carousel';        // Slider "Categories Products" (produits)

  /* Slider 1 : catégories (autoplay) */
  function initCategorySlider($) {
    var $sliders = $(SEL_CAT);
    if (!$sliders.length) return;

    $sliders.each(function () {
      var $el = $(this);
      if ($el.data('tvinit')) return; // évite double init

      // Si déjà initialisé, nettoyer puis réinitialiser
      if ($el.hasClass('owl-loaded')) {
        $el.trigger('destroy.owl.carousel');
        $el.removeClass('owl-loaded owl-drag owl-text-select-on');
        var $outer = $el.children('.owl-stage-outer');
        if ($outer.length) $outer.children().unwrap();
      }

      $el.owlCarousel({
        loop: true,
        autoplay: true,
        autoplayTimeout: 2500,
        autoplayHoverPause: true,
        smartSpeed: 600,
        margin: 16,
        nav: false,
        dots: true,
        rtl: document.documentElement.dir === 'rtl',
        responsive: {
          0:    { items: 2 },
          576:  { items: 3 },
          992:  { items: 4 },
          1200: { items: 5 }
        }
      });

      $el.data('tvinit', true);
    });
  }

  /* Slider 2 : products (autoplay + nav externe + reinit onglets) */
  function initTabProductSlider($) {
    var $sliders = $(SEL_TAB);
    if (!$sliders.length) return;

    $sliders.each(function () {
      var $el = $(this);
      if ($el.data('tvinit')) return;

      if ($el.hasClass('owl-loaded')) {
        $el.trigger('destroy.owl.carousel');
        $el.removeClass('owl-loaded owl-drag owl-text-select-on');
        var $outer = $el.children('.owl-stage-outer');
        if ($outer.length) $outer.children().unwrap();
      }

      $el.owlCarousel({
        loop: true,
        autoplay: true,
        autoplayTimeout: 2500,
        autoplayHoverPause: true,
        smartSpeed: 600,
        margin: 16,
        nav: false,
        dots: true,
        rtl: document.documentElement.dir === 'rtl',
        responsive: {
          0:    { items: 2 },
          576:  { items: 2 },
          768:  { items: 3 },
          992:  { items: 4 },
          1200: { items: 5 }
        }
        // Optionnel : stagePadding: 24
      });

      $el.data('tvinit', true);
    });
  }

  /* Boutons externes (prev/next) pour le slider produits */
  function bindExternalNav($) {
    $(document).off('click.tvtab-owl-nav').on('click.tvtab-owl-nav',
      '.tvcmsprev-btn, .tvcmsnext-btn', function (e) {
        e.preventDefault();
        var $container = $(this).closest('.tvcmstabcategory-product-slider');
        var $slider = $container.find(SEL_TAB);
        if (!$slider.length) return;
        if ($(this).hasClass('tvcmsprev-btn')) $slider.trigger('prev.owl.carousel');
        else $slider.trigger('next.owl.carousel');
      }
    );
  }

  /* Re-init après click sur un onglet catégorie (le module recharge via AJAX) */
  function bindTabReinit($) {
    $(document).off('click.tvtab-reinit').on('click.tvtab-reinit',
      '.tvtabcategory-product-li a', function () {
        setTimeout(function(){ initTabProductSlider($); }, 400);
      }
    );
  }

  /* Boot commun (attend jQuery + Owl) */
  function boot() {
    if (window.jQuery && window.jQuery.fn && window.jQuery.fn.owlCarousel) {
      var $ = window.jQuery;

      initCategorySlider($);
      initTabProductSlider($);
      bindExternalNav($);
      bindTabReinit($);

      // Re-init global après AJAX
      $(document).on('ajaxComplete', function(){
        initCategorySlider($);
        initTabProductSlider($);
      });

      // Re-init si du DOM est injecté
      try {
        new MutationObserver(function(){
          initCategorySlider($);
          initTabProductSlider($);
        }).observe(document.body, { childList: true, subtree: true });
      } catch (e) {}

    } else {
      // jQuery ou Owl pas encore prêts → ré-essaye
      setTimeout(boot, 200);
    }
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', boot);
  } else {
    boot();
  }
  window.addEventListener('load', boot);
})();

  /* défiler auto 3 bloc avec sous catégories */
document.addEventListener('DOMContentLoaded', function () {
  if (!window.jQuery || !jQuery.fn.owlCarousel) return;

  // Cible uniquement ce slider (adaptable si besoin)
  var $carousels = jQuery('.owl-carousel').has('.tvcategory-chain-slider-info-wrapper');

  $carousels.each(function () {
    var $owl = jQuery(this);
    if ($owl.hasClass('owl-loaded')) {
      // Déjà initialisé → on lance l’autoplay
      $owl.trigger('play.owl.autoplay', [4000]); // 4000ms
    } else {
      // Pas initialisé → on init avec autoplay
      $owl.owlCarousel({
        items: 3,
        loop: true,
        autoplay: true,
        autoplayTimeout: 4000,
        autoplayHoverPause: true,
        smartSpeed: 600,
        responsive: {
          0:   { items: 1 },
          576: { items: 2 },
          992: { items: 3 }
        }
      });
    }
  });
});

/* === Tally Embed Safe Loader (no globals, no conflicts) === */
(function () {
  'use strict';

  var WIDGET_URL = 'https://tally.so/widgets/embed.js';
  var LOAD_DEBOUNCE_MS = 250;
  var debounceTimer = null;

  // Si le widget Tally n'est pas dispo, on pose src depuis data-tally-src pour un affichage "statique"
  function hydrateIframesFallback() {
    var nodes = document.querySelectorAll('iframe[data-tally-src]:not([src])');
    for (var i = 0; i < nodes.length; i++) {
      var el = nodes[i];
      var src = el.getAttribute('data-tally-src');
      if (src) el.setAttribute('src', src);
    }
  }

  function initEmbeds() {
    if (window.Tally && typeof window.Tally.loadEmbeds === 'function') {
      window.Tally.loadEmbeds();         // active dynamicHeight, etc.
    } else {
      hydrateIframesFallback();          // fallback si le script n'a pas chargé
    }
  }

  function ensureWidgetLoaded(cb) {
    // Déjà présent ?
    if (window.Tally && typeof window.Tally.loadEmbeds === 'function') {
      cb();
      return;
    }

    // Script déjà injecté ailleurs ?
    var existing = document.querySelector(
      'script[src="' + WIDGET_URL + '"], script[src^="' + WIDGET_URL + '"]'
    );
    if (existing) {
      existing.addEventListener('load', cb, { once: true });
      existing.addEventListener('error', function () {
        hydrateIframesFallback();
        cb();
      }, { once: true });
      return;
    }

    // Injection contrôlée du script
    var s = document.createElement('script');
    s.src = WIDGET_URL;
    s.async = true;
    s.onload = cb;
    s.onerror = function () {
      hydrateIframesFallback();
      cb();
    };
    (document.body || document.documentElement).appendChild(s);
  }

  function debouncedInit() {
    clearTimeout(debounceTimer);
    debounceTimer = setTimeout(function () {
      ensureWidgetLoaded(initEmbeds);
    }, LOAD_DEBOUNCE_MS);
  }

  // Ready helpers (sans polluer le global)
  function onReady(fn) {
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', fn);
    } else {
      fn();
    }
  }

  // Lancements clés
  onReady(debouncedInit);
  window.addEventListener('load', debouncedInit);

  // Si du DOM est injecté (modules qui remplacent le contenu), on relance proprement
  try {
    var mo = new MutationObserver(function (muts) {
      for (var i = 0; i < muts.length; i++) {
        if (muts[i].addedNodes && muts[i].addedNodes.length) {
          debouncedInit();
          break;
        }
      }
    });
    mo.observe(document.documentElement, { childList: true, subtree: true });
  } catch (e) { /* silencieux */ }

  // Si jQuery est présent, on accroche ajaxComplete sans collision
  if (window.jQuery && typeof window.jQuery === 'function') {
    window.jQuery(document).off('.tallyembed').on('ajaxComplete.tallyembed', debouncedInit);
  }
})();

